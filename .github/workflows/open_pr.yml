name: Start reviewapp when PR is opened&#10&#10on:&#10  pull_request:&#10    types: [ opened, reopened ]&#10&#10jobs:&#10  start_reviewapp:&#10    name: Start reviewapp&#10    runs-on: ubuntu-latest&#10    steps:&#10      - name: Add comment for start of job&#10        uses: peter-evans/create-or-update-comment@v4&#10        with:&#10          issue-number: ${{ github.event.pull_request.number }}&#10          body: |&#10            Starting reviewapp&#10&#10      - name: Log in to Azure&#10        uses: azure/login@v1&#10        with:&#10          creds: '{"clientId":"${{ vars.ARM_CLIENT_ID }}","clientSecret":"${{ secrets.ARM_CLIENT_SECRET }}","subscriptionId":"${{ vars.ARM_SUBSCRIPTION_ID }}","tenantId":"${{ vars.ARM_TENANT_ID }}"}'&#10&#10      - name: Deploy review app&#10        id: deploy&#10        env:&#10          ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}&#10          REF_NAME: ${{ github.head_ref }}&#10        shell: bash&#10        run: |&#10          CI_COMMIT_BRANCH="$REF_NAME"&#10          ENV_SLUG=$(echo "${REF_NAME}" | sed -e 's:[^[:alpha:]|^[:digit:]]:-:g' | sed -e 's/\(.*\)/\L\1/')&#10          NEW_DB_SUFFIX = "intranet_${ENV_SLUG}"&#10          tag=":$ENV_SLUG"&#10          az extension add --name containerapp --allow-preview true&#10          az containerapp job start -n intranet-dbclone -g rg-ecc-intranet-uks-dev --subscription "Essex County Council (Intranet)" --image "acreccuksdev.azurecr.io/dbclone" --env-vars "NEW_DB_SUFFIX=${NEW_DB_SUFFIX}" 'MYSQL_HOST=mariadb-ecc-uks-dev.mariadb.database.azure.com' 'MYSQL_USER=mariadb-root' 'MYSQL_DATABASE=drupal_intranet' 'MYSQL_PASSWORD=secretref:mysql-password' --container-name dbclonea --cpu 0.75 --memory 1.5&#10          echo "Running on branch '$CI_COMMIT_BRANCH': tag = $tag"&#10          sleep 4m&#10          jq -n --argjson revisions $(az containerapp revision list -n intranet -g rg-ecc-intranet-uks-dev --subscription "Essex County Council (Intranet)" | jq -c '[.[].name]') --argjson ingress $(az containerapp ingress show -n intranet -g rg-ecc-intranet-uks-dev --subscription "Essex County Council (Intranet)"  | jq -c ".traffic | [.[].revisionName]") '{"revisions": $revisions, "ingress": $ingress} | .revisions-.ingress | .[]' | tr -d '"' | while read revision&#10          do&#10            echo Deactivating "$revision"&#10            az containerapp revision deactivate --revision $revision -g rg-ecc-intranet-uks-dev --subscription "Essex County Council (Intranet)"&#10          done&#10          echo "Creating new revision of Container App"&#10          cat > revision.yml <<EOF&#10          properties:&#10            template:&#10              revisionSuffix: gh${GITHUB_RUN_ID}&#10              scale:&#10                minReplicas: 0&#10                maxReplicas: 1&#10                rules:&#10                  - name: "http-rule"&#10                    http:&#10                      metadata:&#10                        concurrentRequests: 40&#10              containers:&#10                - image: acreccuksdev.azurecr.io/intranet-nginx-drupal$tag&#10                  name: nginx&#10                  resources:&#10                    cpu: 0.25&#10                    memory: 0.5Gi&#10                  volumeMounts:&#10                  - mountPath: /drupal/web/sites/default/files&#10                    volumeName: filesharevol&#10                  env:&#10                  - name: X_ROBOTS_TAG&#10                    value: noindex&#10                  probes:&#10                  - type: liveness&#10                    httpGet:&#10                      path: "/dd822309-ae33-4e29-addf-869b07453a06"&#10                      port: 80&#10                    initialDelaySeconds: 5&#10                    periodSeconds: 3&#10                - image: acreccuksdev.azurecr.io/intranet-drupal-fpm$tag&#10                  name: drupal&#10                  resources:&#10                    cpu: 0.75&#10                    memory: 1.5Gi&#10                  volumeMounts:&#10                  - mountPath: /drupal/web/sites/default/files&#10                    volumeName: filesharevol&#10                  - mountPath: /drupal/data/default/private&#10                    volumeName: privsharevol&#10                  env:&#10                  - name: MYSQL_HOST&#10                    value: mariadb-ecc-uks-dev.mariadb.database.azure.com&#10                  - name: MYSQL_USER&#10                    value: mariadb-root&#10                  - name: MYSQL_DATABASE&#10                    value: drupal_ci_${NEW_DB_SUFFIX}&#10                  - name: MYSQL_PASSWORD&#10                    secretRef: mysql-password&#10                  - name: OPENID_CONNECT_PARAMS&#10                    secretRef: openid-connect-params&#10                  - name: NOMENSA_AAD_CLIENT_SECRET&#10                    secretRef: nomensa-aad-client-secret&#10                  - name: CLIENT_AAD_CLIENT_SECRET&#10                    secretRef: client-aad-client-secret&#10                  - name: ENVIRONMENT&#10                    value: dev&#10                  - name: FATHOM_ID&#10                    value: ''&#10                  probes:&#10                  - type: liveness&#10                    tcpSocket:&#10                      port: 9000&#10                    initialDelaySeconds: 5&#10                    periodSeconds: 3&#10          EOF&#10          az containerapp revision copy -n intranet -g rg-ecc-intranet-uks-dev --yaml revision.yml --subscription "Essex County Council (Intranet)" | tee revision.json &#10          az containerapp revision label add --no-prompt -g rg-ecc-intranet-uks-dev -n intranet --label ${ENV_SLUG} --revision intranet--gh${GITHUB_RUN_ID} --subscription "Essex County Council (Intranet)"&#10          echo "env_slug=${ENV_SLUG}" >> "$GITHUB_OUTPUT"&#10&#10      - name: Drush deploy&#10        id: drush_deploy&#10        env:&#10          ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}&#10          REF_NAME: ${{ github.head_ref }}&#10        shell: bash&#10        run: |&#10          CI_COMMIT_BRANCH="$REF_NAME"&#10          ENV_SLUG=$(echo "${REF_NAME}" | sed -e 's:[^[:alpha:]|^[:digit:]]:-:g' | sed -e 's/\(.*\)/\L\1/')&#10          tag=":$ENV_SLUG"&#10          echo Drush deploy started&#10          sudo apt-get -qq update&#10          sudo apt-get -y install socat&#10          timeout 1200 socat EXEC:"az containerapp exec --command /drupal/deploy.sh -n intranet --container drupal --revision intranet--gh${GITHUB_RUN_ID} -g rg-ecc-intranet-uks-dev --subscription \'Essex County Council (Intranet)\'",pty,setsid,ctty STDIO,ignoreeof&#10          echo Drush deploy finished&#10&#10      - name: Add comment&#10        uses: peter-evans/create-or-update-comment@v4&#10        with:&#10          issue-number: ${{ github.event.pull_request.number }}&#10          body: |&#10            Started reviewapp&#10            https://intranet---${{ steps.deploy.outputs.env_slug }}.braveplant-96d7f42a.uksouth.azurecontainerapps.io/&#10